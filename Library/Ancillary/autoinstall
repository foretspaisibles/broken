#!/bin/sh

### autoinstall -- Autoinstall dependencies

# Broken (https://github.com/michipili/broken)
# This file is part of Broken
#
# Copyright © 2015 Michael Grünewald
#
# This file must be used under the terms of the CeCILL-B.
# This source file is licensed as described in the file COPYING, which
# you should have received as part of this distribution. The terms
# are also available at
# http://www.cecill.info/licences/Licence_CeCILL-B_V1-en.txt

: ${prefix:=${HOME}/.local}
: ${srcdir:=${HOME}/.local/sources}

autoinstall_bsdowl_version='master'


autoinstall_bmake()
{
    install -d "${srcdir}"
    cd "${srcdir}"

    curl -s http://void.crufty.net/ftp/pub/sjg/bmake.tar.gz\
        | tar xzfC - "${srcdir}"

    curl -s http://void.crufty.net/ftp/pub/sjg/mk.tar.gz\
        | tar xzfC - "${srcdir}/bmake"

    ./bmake/boot-strap --prefix="${prefix}" --install
    ./bmake/boot-strap --prefix="${prefix}" op=install
}

autoinstall_bsdowl()
{
    install -d "${srcdir}"
    cd "${srcdir}"

    git clone https://github.com/michipili/bsdowl
    cd bsdowl
    git checkout "${autoinstall_bsdowl_version}"
    autoconf
    ./configure --prefix="${prefix}"
    bmake build
    bmake install
}


autoinstall_ocamlfind()
{
    set -a
    OPAMYES=1
    OPAMVERBOSE=1
    set +a

    opam init
    opam install ocamlfind
}

autoinstall_usage()
{
    iconv -c -f utf-8 <<EOF
Usage: autoinstall [-h][-s SRCDIR] [-p PREFIX] bsdowl bmake
 Install bmake and bsdowl
Options:
 -h Display this help message.
 -p PREFIX [${prefix}]
    Use PREFIX as installation prefix.
 -s SRCDIR [${srcdir}]
    Download sources to SRCDIR.
EOF
}

while getopts "hs:p:" OPTION; do
    case "${OPTION}" in
        h)	autoinstall_usage; exit 0;;
        s)	srcdir="${OPTARG}";;
        p)	prefix="${OPTARG}";;
        ?)	autoinstall_usage; exit 64;;
    esac
done
shift $(expr $OPTIND - 1)
for package in "$@"; do
    case "${package}" in
        ocamlfind|bmake|bsdowl);;
        *) autoinstall_usage; exit 64;;
    esac
done
for package in "$@"; do
    autoinstall_${package}
done

### End of file `autoinstall'
